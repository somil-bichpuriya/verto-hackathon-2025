import { Customer, ICustomer } from '../models/Customer.model';
import { Partner, IPartner } from '../models/Partner.model';
import { ValidationError } from '../utils/AppError';
import bcrypt from 'bcryptjs';

export class RegistrationService {
  /**
   * Register a new customer
   */
  async registerCustomer(data: {
    companyName: string;
    email: string;
    address: string;
    password: string;
  }): Promise<ICustomer> {
    // Check if customer already exists
    const existingCustomer = await Customer.findOne({
      $or: [{ email: data.email }, { companyName: data.companyName }],
    });

    if (existingCustomer) {
      if (existingCustomer.email === data.email) {
        throw new ValidationError('Customer with this email already exists');
      }
      throw new ValidationError('Customer with this company name already exists');
    }

    // Hash password
    const passwordHash = await bcrypt.hash(data.password, 10);

    // Create new customer
    const customer = await Customer.create({
      companyName: data.companyName,
      email: data.email,
      address: data.address,
      passwordHash,
    });
    return customer;
  }

  /**
   * Register a new partner with auto-generated API keys
   */
  async registerPartner(data: {
    companyName: string;
    email: string;
    documentTypesConfig: string[];
    password: string;
  }): Promise<{ partner: IPartner; apiKey: string; apiSecret: string }> {
    // Check if partner already exists
    const existingPartner = await Partner.findOne({
      $or: [{ email: data.email }, { companyName: data.companyName }],
    });

    if (existingPartner) {
      if (existingPartner.email === data.email) {
        throw new ValidationError('Partner with this email already exists');
      }
      throw new ValidationError('Partner with this company name already exists');
    }

    // Hash password
    const passwordHash = await bcrypt.hash(data.password, 10);

    // Create new partner (apiKey and apiSecret will be auto-generated by pre-save hook)
    const partner = await Partner.create({
      companyName: data.companyName,
      email: data.email,
      documentTypesConfig: data.documentTypesConfig,
      passwordHash,
    });

    // Fetch the partner with apiSecret (since it's not selected by default)
    const partnerWithSecret = await Partner.findById(partner._id).select('+apiSecret');

    if (!partnerWithSecret) {
      throw new Error('Failed to retrieve partner after creation');
    }

    return {
      partner: partner,
      apiKey: partnerWithSecret.apiKey,
      apiSecret: partnerWithSecret.apiSecret,
    };
  }
}

export const registrationService = new RegistrationService();
